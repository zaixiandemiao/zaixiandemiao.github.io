<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="etcd,kubernetes," />





  <link rel="alternate" href="/atom.xml" title="记忆碎片" type="application/atom+xml" />






<meta name="description" content="背景Etcd是一个分布式的K/V存储组件，主要用于存储元数据和配置数据，典型应用是Kubernetes中，用于服务发现和节点注册。本篇文章主要介绍了3节点下安装Etcd集群及其配置过程，主要参考了青蛙小白的博客，解决了安装过程中的一部分问题，并加入了etcdctl工具的配置步骤，方便日后的参考。">
<meta name="keywords" content="etcd,kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="Etcd集群安装">
<meta property="og:url" content="http://www.wangjialong.cc/2017/10/31/etcd_install/index.html">
<meta property="og:site_name" content="记忆碎片">
<meta property="og:description" content="背景Etcd是一个分布式的K/V存储组件，主要用于存储元数据和配置数据，典型应用是Kubernetes中，用于服务发现和节点注册。本篇文章主要介绍了3节点下安装Etcd集群及其配置过程，主要参考了青蛙小白的博客，解决了安装过程中的一部分问题，并加入了etcdctl工具的配置步骤，方便日后的参考。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-10-31T11:24:30.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Etcd集群安装">
<meta name="twitter:description" content="背景Etcd是一个分布式的K/V存储组件，主要用于存储元数据和配置数据，典型应用是Kubernetes中，用于服务发现和节点注册。本篇文章主要介绍了3节点下安装Etcd集群及其配置过程，主要参考了青蛙小白的博客，解决了安装过程中的一部分问题，并加入了etcdctl工具的配置步骤，方便日后的参考。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.wangjialong.cc/2017/10/31/etcd_install/"/>





  <title>Etcd集群安装 | 记忆碎片</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-106491334-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?1f747f42c68e406fa30ea2a76a4e3787";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">记忆碎片</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wangjialong.cc/2017/10/31/etcd_install/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zaixiandemiao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="记忆碎片">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Etcd集群安装</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-31T00:00:00+08:00">
                2017-10-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv">本文总阅读量
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>Etcd是一个分布式的K/V存储组件，主要用于存储元数据和配置数据，典型应用是Kubernetes中，用于服务发现和节点注册。本篇文章主要介绍了3节点下安装Etcd集群及其配置过程，主要参考了<a href="http://blog.frognew.com/2017/04/install-etcd-cluster.html" target="_blank" rel="external">青蛙小白</a>的博客，解决了安装过程中的一部分问题，并加入了etcdctl工具的配置步骤，方便日后的参考。</p>
<a id="more"></a>
<h1 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h1><p>Centos 7<br>IP | hostname<br>—|—<br>192.168.202.131 | etcd-1<br>192.168.202.132 | etcd-2<br>192.168.202.133 | etcd-3</p>
<h1 id="TLS密钥和证书"><a href="#TLS密钥和证书" class="headerlink" title="TLS密钥和证书"></a>TLS密钥和证书</h1><p>部署的etcd集群使用TLS证书对集群中节点间通信进行加密，并开启基于CA根证书签名的双向数字证书认证。本文档使用<a href="https://github.com/cloudflare/cfssl" target="_blank" rel="external">cfssl</a>来生成CA证书以及其他需要的证书。生成的证书列表如下：  </p>
<ul>
<li>ca.pem</li>
<li>etcd.pem</li>
<li>etcd-key.pem<br>下面介绍使用cfssl生成所需要的私钥和证书.</li>
</ul>
<h1 id="安装cfssl"><a href="#安装cfssl" class="headerlink" title="安装cfssl"></a>安装<a href="https://github.com/cloudflare/cfssl" target="_blank" rel="external">cfssl</a></h1><h2 id="方式一：直接使用二进制包安装"><a href="#方式一：直接使用二进制包安装" class="headerlink" title="方式一：直接使用二进制包安装"></a>方式一：直接使用二进制包安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</div><div class="line">$ chmod +x cfssl_linux-amd64</div><div class="line">$ sudo mv cfssl_linux-amd64 /root/local/bin/cfssl</div><div class="line"></div><div class="line">$ wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</div><div class="line">$ chmod +x cfssljson_linux-amd64</div><div class="line">$ sudo mv cfssljson_linux-amd64 /root/local/bin/cfssljson</div><div class="line"></div><div class="line">$ wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</div><div class="line">$ chmod +x cfssl-certinfo_linux-amd64</div><div class="line">$ sudo mv cfssl-certinfo_linux-amd64 /root/local/bin/cfssl-certinfo</div><div class="line"></div><div class="line">$ export PATH=/root/local/bin:$PATH</div></pre></td></tr></table></figure>
<h2 id="方式二：使用go命令安装"><a href="#方式二：使用go命令安装" class="headerlink" title="方式二：使用go命令安装"></a>方式二：使用go命令安装</h2><p>如果系统中安装过Go的话，可以直接使用命令安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ go get -u github.com/cloudflare/cfssl/cmd/...</div><div class="line">$ echo $GOPATH</div><div class="line">/usr/local</div><div class="line">$ ls /usr/local/bin/cfssl*</div><div class="line">cfssl cfssl-bundle cfssl-certinfo cfssljson cfssl-newkey cfssl-scan</div></pre></td></tr></table></figure></p>
<h1 id="创建CA证书"><a href="#创建CA证书" class="headerlink" title="创建CA证书"></a>创建CA证书</h1><h2 id="创建CA的配置文件ca-config-json"><a href="#创建CA的配置文件ca-config-json" class="headerlink" title="创建CA的配置文件ca-config.json"></a>创建CA的配置文件ca-config.json</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">$ mkdir /root/ssl</div><div class="line">$ cd /root/ssl</div><div class="line">$ cfssl print-defaults config &gt; ca-config.json</div><div class="line">$ cfssl print-defaults csr &gt; ca-csr.json</div><div class="line">$ cat ca-config.json</div><div class="line">&#123;</div><div class="line">  &quot;signing&quot;: &#123;</div><div class="line">    &quot;default&quot;: &#123;</div><div class="line">      &quot;expiry&quot;: &quot;8760h&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;profiles&quot;: &#123;</div><div class="line">      &quot;frognew&quot;: &#123;</div><div class="line">        &quot;usages&quot;: [</div><div class="line">            &quot;signing&quot;,</div><div class="line">            &quot;key encipherment&quot;,</div><div class="line">            &quot;server auth&quot;,</div><div class="line">            &quot;client auth&quot;</div><div class="line">        ],</div><div class="line">        &quot;expiry&quot;: &quot;87600h&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ca-config.json中可以定义多个profile，分别设置不同的expiry和usages等参数。如上面的ca-config.json中定义了名称为frognew的profile，这个profile的expiry 87600h为10年，useages中：</p>
<ul>
<li>signing表示此CA证书可以用于签名其他证书，ca.pem中的CA=TRUE</li>
<li>server auth表示TLS Server Authentication, 即client可以用该 CA 对server提供的证书进行验证</li>
<li>client auth表示TLS Client Authentication，即server可以用该CA对client提供的证书进行验证</li>
</ul>
<h2 id="创建CA证书签名请求配置ca-csr-json："><a href="#创建CA证书签名请求配置ca-csr-json：" class="headerlink" title="创建CA证书签名请求配置ca-csr.json："></a>创建CA证书签名请求配置ca-csr.json：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;CN&quot;: &quot;frognew&quot;,</div><div class="line">  &quot;key&quot;: &#123;</div><div class="line">    &quot;algo&quot;: &quot;rsa&quot;,</div><div class="line">    &quot;size&quot;: 2048</div><div class="line">  &#125;,</div><div class="line">  &quot;names&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;C&quot;: &quot;CN&quot;,</div><div class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</div><div class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</div><div class="line">      &quot;O&quot;: &quot;frognew&quot;,</div><div class="line">      &quot;OU&quot;: &quot;cloudnative&quot;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面使用cfssl生成CA证书和私钥:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca</div><div class="line">$ ls ca*</div><div class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</div></pre></td></tr></table></figure>
<h1 id="Etcd证书和私钥"><a href="#Etcd证书和私钥" class="headerlink" title="Etcd证书和私钥"></a>Etcd证书和私钥</h1><p>创建etcd证书签名请求配置etcd-csr.json：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;CN&quot;: &quot;frognew&quot;,</div><div class="line">    &quot;hosts&quot;: [</div><div class="line">      &quot;127.0.0.1&quot;,</div><div class="line">      &quot;192.168.202.131&quot;,</div><div class="line">      &quot;192.168.202.132&quot;,</div><div class="line">      &quot;192.168.202.133&quot;,</div><div class="line">      &quot;etcd-1&quot;,</div><div class="line">      &quot;etcd-2&quot;,</div><div class="line">      &quot;etcd-3&quot;</div><div class="line">    ],</div><div class="line">    &quot;key&quot;: &#123;</div><div class="line">        &quot;algo&quot;: &quot;rsa&quot;,</div><div class="line">        &quot;size&quot;: 2048</div><div class="line">    &#125;,</div><div class="line">    &quot;names&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;C&quot;: &quot;CN&quot;,</div><div class="line">            &quot;ST&quot;: &quot;BeiJing&quot;,</div><div class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</div><div class="line">            &quot;O&quot;: &quot;frognew&quot;,</div><div class="line">            &quot;OU&quot;: &quot;cloudnative&quot;</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意上面配置hosts字段中制定授权使用该证书的IP和域名列表，因为现在要生成的证书需要被etcd集群各个节点使用，所以这里指定了各个节点的IP和hostname。</p>
<p>下面生成etcd的证书和私钥：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=frognew etcd-csr.json | cfssljson -bare etcd</div><div class="line"></div><div class="line">$ ls etcd*</div><div class="line">etcd.csr  etcd-csr.json  etcd-key.pem  etcd.pem</div></pre></td></tr></table></figure>
<ul>
<li><strong>注意</strong>：确认-config的参数文件名和路径正确，可以使用绝对路径；etcd-csr.json在当前目录下存在，也可以为绝对路径，否则会报config文件json格式有误，但并不是文件内容的错误，而是路径和文件名错误。<br>对生成的证书可以使用cfssl或者openssl查看：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ cfssl-certinfo -cert etcd.pem</div><div class="line"></div><div class="line">$ openssl x509  -noout -text -in  etcd.pem</div></pre></td></tr></table></figure>
<ul>
<li>确认 Issuer 字段的内容和 ca-csr.json 一致；</li>
<li>确认 Subject 字段的内容和 etcd-csr.json 一致；</li>
<li>确认 X509v3 Subject Alternative Name 字段的内容和 etcd-csr.json 一致；</li>
<li>确认 X509v3 Key Usage、Extended Key Usage 字段的内容和 ca-config.json 中 profile 一致；</li>
</ul>
<h1 id="安装etcd"><a href="#安装etcd" class="headerlink" title="安装etcd"></a>安装etcd</h1><p>Etcd可以使用二进制安装和yum源安装两种方式</p>
<h2 id="二进制安装"><a href="#二进制安装" class="headerlink" title="二进制安装"></a>二进制安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget https://github.com/coreos/etcd/releases/download/v3.1.6/etcd-v3.1.6-linux-amd64.tar.gz</div></pre></td></tr></table></figure>
<p>解压缩etcd-v3.1.6-linux-amd64.tar.gz，将其中的etcd和etcdctl两个可执行文件复制到各节点的/usr/bin目录。</p>
<h2 id="yum源安装"><a href="#yum源安装" class="headerlink" title="yum源安装"></a>yum源安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ yum list etcd</div><div class="line">$ yum install -y etcd</div></pre></td></tr></table></figure>
<p>安装完成之后，在各节点创建etcd的数据目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir -p /var/lib/etcd</div></pre></td></tr></table></figure>
<p>使用systemctl启动和管理etcd服务，在每个节点上创建etcd的systemd unit文件/usr/lib/systemd/system/etcd.service，注意替换ETCD_NAME和INTERNAL_IP变量的值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">export ETCD_NAME=node1</div><div class="line">export INTERNAL_IP=192.168.202.131</div><div class="line">cat  /usr/lib/systemd/system/etcd.service</div><div class="line">[Unit]</div><div class="line">Description=etcd server</div><div class="line">After=network.target</div><div class="line">After=network-online.target</div><div class="line">Wants=network-online.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line">WorkingDirectory=/var/lib/etcd/</div><div class="line">EnvironmentFile=-/etc/etcd/etcd.conf</div><div class="line">ExecStart=/usr/bin/etcd \</div><div class="line">  --name $&#123;ETCD_NAME&#125; \</div><div class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \</div><div class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \</div><div class="line">  --peer-cert-file=/etc/etcd/ssl/etcd.pem \</div><div class="line">  --peer-key-file=/etc/etcd/ssl/etcd-key.pem \</div><div class="line">  --trusted-ca-file=/etc/etcd/ssl/ca.pem \</div><div class="line">  --peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \</div><div class="line">  --initial-advertise-peer-urls https://$&#123;INTERNAL_IP&#125;:2380 \</div><div class="line">  --listen-peer-urls https://$&#123;INTERNAL_IP&#125;:2380 \</div><div class="line">  --listen-client-urls https://$&#123;INTERNAL_IP&#125;:2379,https://127.0.0.1:2379 \</div><div class="line">  --advertise-client-urls https://$&#123;INTERNAL_IP&#125;:2379 \</div><div class="line">  --initial-cluster-token etcd-cluster-1 \</div><div class="line">  --initial-cluster node1=https://192.168.202.131:2380,node2=https://192.168.202.132:2380,node3=https://192.168.202.133:2380 \</div><div class="line">  --initial-cluster-state new \</div><div class="line">  --data-dir=/var/lib/etcd</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">EOF</div></pre></td></tr></table></figure>
<ul>
<li>–data-dir指定了etcd的工作目录和数据目录是/var/lib/etcd</li>
<li>–cert-file和–key-file分别指定etcd的公钥证书和私钥</li>
<li>–peer-cert-file和–peer-key-file分别指定了etcd的Peers通信的公钥证书和私钥。</li>
<li>–trusted-ca-file指定了客户端的CA证书</li>
<li>–peer-trusted-ca-file指定了Peers的CA证书</li>
<li>–initial-cluster-state new表示这是新初始化集群，–name指定的参数值必须在–initial-cluster中  </li>
</ul>
<p><strong>注意</strong>：在etcd.pem生成时hosts配置了Ip地址列表和hostname列表，在etcd的service(/usr/lib/systemd/system/etcd.service)文件中，所有ip不能代替为未包含的hostname，如master</p>
<h1 id="启动Etcd"><a href="#启动Etcd" class="headerlink" title="启动Etcd"></a>启动Etcd</h1><p>在各节点上启动etcd：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ systemctl daemon-reload</div><div class="line">$ systemctl enable etcd</div><div class="line">$ systemctl start etcd</div><div class="line">$ systemctl status etcd</div></pre></td></tr></table></figure>
<p>在启动etcd的时候，可以开启另一个命令窗口，查看启动日志，确保没有报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">journalctl -f</div></pre></td></tr></table></figure>
<ul>
<li>如果出现了形如 <code>unkown flag</code>的字段，表示启动参数错误，不识别,说明该参数拼写错误(<em>如–keyfile应当为–key-file</em>),可以到官方配置文档<a href="https://github.com/coreos/etcd/blob/master/Documentation/op-guide/configuration.md" target="_blank" rel="external">Configuration flags</a>查看该参数的写法，确保正确。</li>
<li>如果出现<code>Failed to find member fXXXXXX</code>的错误，这说明之前启动的etcd时，标识号出现错误，此时删除<code>/var/lib/etcd/member</code>目录，让etcd重新为每个节点分配标识号, <code>/var/lib/etcd</code>为etcd启动配置工作目录</li>
</ul>
<p>如果日志一切正常，可以使用<code>etcdctl</code>检查集群是否健康，在任一节点执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">etcdctl \</div><div class="line">  --ca-file=/etc/etcd/ssl/ca.pem \</div><div class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \</div><div class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \</div><div class="line">  --endpoints=https://node1:2379,https://node2:2379,https://node3:2379 \</div><div class="line">  cluster-health</div><div class="line"></div><div class="line">2017-04-24 19:53:40.545148 I | warning: ignoring ServerName for user-provided CA for backwards compatibility is deprecated</div><div class="line">2017-04-24 19:53:40.546127 I | warning: ignoring ServerName for user-provided CA for backwards compatibility is deprecated</div><div class="line">member 4f2f99d70000fc19 is healthy: got healthy result from https://192.168.202.132:2379</div><div class="line">member 99a756f799eb4163 is healthy: got healthy result from https://192.168.202.131:2379</div><div class="line">member a9aff19397de2e4e is healthy: got healthy result from https://192.168.202.133:2379</div><div class="line">cluster is healthy</div></pre></td></tr></table></figure>
<p>确保输出<code>cluster is healthy</code>的信息。<br>上面的命令使用证书访问，返回正常信息，若未添加证书，使用<code>etcdctl member list</code>访问，应当报错，否则，TLS(安全认证)未生效，即使用http访问etcd集群。</p>
<h1 id="etcdctl配置"><a href="#etcdctl配置" class="headerlink" title="etcdctl配置"></a>etcdctl配置</h1><p>由于使用了TLS安全认证，etcdctl 查询时需要在命令行中指定证书和endpoints，会使得一条命令变得很长，可以预先创建一个etcdctl配置文件，进行相应的配置.</p>
<ol>
<li>创建etcdctl配置文件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ vi /etc/etcd/etcdctl</div><div class="line">$ cat /etc/etcd/etcdctl</div><div class="line">export ETCDCTL_API=3</div><div class="line">export ETCDCTL_ENDPOINTS=&quot;https://etcd-1:2379,https://etcd-2:2379,https://etcd-3:2379&quot;</div><div class="line">export ETCDCTL_CACERT=/etc/etcd/ssl/ca.pem</div><div class="line">export ETCDCTL_CERT=/etc/etcd/ssl/etcd.pem</div><div class="line">export ETCDCTL_KEY=/etc/etcd/ssl/etcd-key.pem</div></pre></td></tr></table></figure>
<ol>
<li>使配置文件生效</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ source /etc/etcd/etcdctl</div></pre></td></tr></table></figure>
<ol>
<li>查看集群状态</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ etcdctl cluster-health</div><div class="line"></div><div class="line">2017-04-24 19:53:40.545148 I | warning: ignoring ServerName for user-provided CA for backwards compatibility is deprecated</div><div class="line">2017-04-24 19:53:40.546127 I | warning: ignoring ServerName for user-provided CA for backwards compatibility is deprecated</div><div class="line">member 4f2f99d70000fc19 is healthy: got healthy result from https://192.168.202.132:2379</div><div class="line">member 99a756f799eb4163 is healthy: got healthy result from https://192.168.202.131:2379</div><div class="line">member a9aff19397de2e4e is healthy: got healthy result from https://192.168.202.133:2379</div><div class="line">cluster is healthy</div></pre></td></tr></table></figure>
<p>etcdctl配置的本质是定义ETCDCTL_ENDPOINT常量，etcdctl运行时读取该常量值，进行连接，具体的常量名称可以参考官方的配置说明<a href="https://github.com/coreos/etcd/tree/master/etcdctl" target="_blank" rel="external">etcdctl config</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://github.com/coreos/etcd/blob/master/Documentation/op-guide/clustering.md" target="_blank" rel="external">Clustering Guide</a></li>
<li><a href="https://github.com/coreos/etcd/tree/master/etcdctl" target="_blank" rel="external">etcdctl config</a></li>
<li><a href="https://github.com/cloudflare/cfssl" target="_blank" rel="external">cloudflare/cfssl</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/etcd/" rel="tag"># etcd</a>
          
            <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/10/20/hdfs_structer/" rel="next" title="HDFS永久性数据结构">
                <i class="fa fa-chevron-left"></i> HDFS永久性数据结构
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/11/01/linux_namespace/" rel="prev" title="Linux中的namespace综述">
                Linux中的namespace综述 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="zaixiandemiao" />
            
              <p class="site-author-name" itemprop="name">zaixiandemiao</p>
              <p class="site-description motion-element" itemprop="description">Sans teeth, sans eyes, sans taste, sans everything</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/zaixiandemiao" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:794815773@qq.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#环境信息"><span class="nav-number">2.</span> <span class="nav-text">环境信息</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TLS密钥和证书"><span class="nav-number">3.</span> <span class="nav-text">TLS密钥和证书</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装cfssl"><span class="nav-number">4.</span> <span class="nav-text">安装cfssl</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#方式一：直接使用二进制包安装"><span class="nav-number">4.1.</span> <span class="nav-text">方式一：直接使用二进制包安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#方式二：使用go命令安装"><span class="nav-number">4.2.</span> <span class="nav-text">方式二：使用go命令安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#创建CA证书"><span class="nav-number">5.</span> <span class="nav-text">创建CA证书</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建CA的配置文件ca-config-json"><span class="nav-number">5.1.</span> <span class="nav-text">创建CA的配置文件ca-config.json</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建CA证书签名请求配置ca-csr-json："><span class="nav-number">5.2.</span> <span class="nav-text">创建CA证书签名请求配置ca-csr.json：</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Etcd证书和私钥"><span class="nav-number">6.</span> <span class="nav-text">Etcd证书和私钥</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装etcd"><span class="nav-number">7.</span> <span class="nav-text">安装etcd</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#二进制安装"><span class="nav-number">7.1.</span> <span class="nav-text">二进制安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#yum源安装"><span class="nav-number">7.2.</span> <span class="nav-text">yum源安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#启动Etcd"><span class="nav-number">8.</span> <span class="nav-text">启动Etcd</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#etcdctl配置"><span class="nav-number">9.</span> <span class="nav-text">etcdctl配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">10.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zaixiandemiao</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.3</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      本站访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      本站总访问数
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  

  

  

</body>
</html>
